<h1>새 카드 컬렉션 작성</h1>

<%= form_with model: @card_collection, local: true, html: { multipart: true } do |f| %>
  <% if @card_collection.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@card_collection.errors.count, "error") %> prevented this card collection from being saved:</h2>
      <ul>
        <% @card_collection.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <!-- 파일 입력 필드 영역: 초기에는 1개만 보임 -->
  <div class="field">
    <label>사진 등록 (최대 10장 업로드 가능)</label><br>
    <div id="file_fields_container">
      <div class="file_field" data-index="0">
        <%= file_field_tag "card_collection[photos][]", id: "card_collection_photos_0" %>
      </div>
    </div>
    <!-- 추가 버튼 -->
    <button type="button" id="add_photo_field">+</button>
  </div>

  <!-- 업로드된 사진 미리보기 영역 -->
  <div id="photos_preview" style="margin-top: 10px;"></div>

  <!-- 투고 내용 입력 -->
  <div class="field">
    <%= f.label :content, "투고 내용" %><br>
    <%= f.text_area :content %>
  </div>

  <!-- 레이아웃 입력 -->
  <div class="field">
    <%= f.label :layout, "레이아웃" %><br>
    <%= f.select :layout, options_for_select(["1R", "1K/1DK", "1LDK/2DK", "2LDK", "3LDK以上"]) %>
  </div>

  <!-- 테마 입력 -->
  <div class="field">
  <%= f.label :theme, "테마" %><br>
  <%= f.select :theme, options_for_select(["お部屋写真", "収納TIP", "ペット", "プラントテリア", "その他"]) %>
</div>

  <div class="actions">
    <%= f.submit "투고하기", id: "submit_btn" %>
  </div>
<% end %>

<!-- JavaScript: 파일 입력 필드 동적 관리, 미리보기 및 제출 버튼 활성/비활성화 -->
<script>
document.addEventListener("turbolinks:load", function() {
  var container = document.getElementById("file_fields_container");
  var addButton = document.getElementById("add_photo_field");
  var previewContainer = document.getElementById("photos_preview");
  var maxFields = 10;
  var submitBtn = document.getElementById("submit_btn");

  // 초기 상태: 이미지가 없으면 제출 버튼 비활성화
  updateSubmitButton();

  // 추가 버튼 클릭: 새 파일 입력 필드 추가 (최대 10개)
  addButton.addEventListener("click", function(e) {
    e.preventDefault();
    var fileInputs = container.querySelectorAll('input[type="file"][name="card_collection[photos][]"]');
    if (fileInputs.length < maxFields) {
      container.appendChild(createFileInput(fileInputs.length));
    } else {
      alert("최대 10개까지 업로드할 수 있습니다.");
    }
  });

  // 파일 입력 필드 change 이벤트 위임
  container.addEventListener("change", function(e) {
    if (e.target && e.target.type === "file") {
      handleFileSelected(e.target);
    }
  });

  function handleFileSelected(fileInput) {
    if (fileInput.files && fileInput.files.length > 0) {
      var file = fileInput.files[0];
      var reader = new FileReader();
      reader.onload = function(e) {
        // data-index를 가져와서 해당 필드가 첫 번째인지 확인
        var fieldDiv = fileInput.parentNode;
        var index = fieldDiv.getAttribute("data-index");
        var isFirst = (index === "0");

        // 첫 번째 입력 필드는 숨기지 않고 그대로 유지; 나머지는 숨김
        if (!isFirst) {
          fileInput.style.display = "none";
        }

        // 미리보기 컨테이너 생성
        var previewDiv = document.createElement("div");
        previewDiv.className = "preview";
        previewDiv.setAttribute("data-index", index);

        var img = document.createElement("img");
        img.src = e.target.result;
        img.style.maxWidth = "200px";
        img.style.display = "block";

        var deleteButton = document.createElement("button");
        deleteButton.type = "button";
        deleteButton.textContent = "삭제";
        deleteButton.addEventListener("click", function() {
          var currentIndex = previewDiv.getAttribute("data-index");
          if (currentIndex === "0") {
            // 첫 번째 입력 필드: 미리보기만 제거하고 값 초기화, 입력 필드 보이게 함
            fileInput.value = "";
            previewDiv.parentNode.removeChild(previewDiv);
          } else {
            // 두 번째 이후: 미리보기와 해당 입력 필드 모두 제거
            fileInput.parentNode.parentNode.removeChild(fileInput.parentNode);
          }
          updateSubmitButton();
          ensureAtLeastOneInput();
        });

        previewDiv.appendChild(img);
        previewDiv.appendChild(deleteButton);
        previewContainer.appendChild(previewDiv);

        // 자동 새 파일 입력 필드 추가: 모든 file_field가 파일 선택된 경우
        ensureAtLeastOneInput();
        updateSubmitButton();
      };
      reader.readAsDataURL(file);
    }
  }

  function createFileInput(index) {
    var newDiv = document.createElement("div");
    newDiv.className = "file_field";
    newDiv.setAttribute("data-index", index);
    var newId = "card_collection_photos_" + Date.now();
    newDiv.innerHTML = '<input type="file" name="card_collection[photos][]" id="' + newId + '">';
    return newDiv;
  }

  function ensureAtLeastOneInput() {
    var fileInputs = container.querySelectorAll('input[type="file"][name="card_collection[photos][]"]');
    // 만약 container에 파일 입력 필드가 하나도 없으면, 첫 번째 입력 필드를 추가
    if (fileInputs.length === 0) {
      container.appendChild(createFileInput(0));
    }
  }

  function updateSubmitButton() {
    // 제출 버튼은 미리보기 영역에 적어도 하나의 preview가 있으면 활성화
    if (previewContainer.children.length > 0) {
      submitBtn.disabled = false;
    } else {
      submitBtn.disabled = true;
    }
  }
});
</script>
