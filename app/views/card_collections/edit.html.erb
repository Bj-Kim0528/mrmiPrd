<%= form_with model: @card_collection, local: true, html: { multipart: true } do |f| %>
  <div>
    <label>自分のPCから写真を投稿する（最大10枚）</label><br>
    <div id="file_fields_container">
      <% @card_collection.photos.each_with_index do |photo, index| %>
        <div data-index="<%= index %>">
          <!-- 기존 첨부 id와 현재 상태 flag (기본값 0: 변경없음) -->
          <input type="hidden" name="card_collection[existing_photo_ids][]" value="<%= photo.id %>">
          <input type="hidden" name="card_collection[flags][]" value="0" class="flag-input">
          
          <input type="file" name="card_collection[photos][]" id="card_collection_photos_<%= index %>" accept="image/*">
          <div id="preview_<%= index %>">
            <% if photo.present? %>
              <%= image_tag url_for(photo), style: "max-width:200px; display:block;" %>
            <% end %>
          </div>
          <textarea name="card_collection[contents][]" placeholder="写真の内容" id="content_<%= index %>">
            <%= @card_collection.contents[index] %>
          </textarea>
          <button type="button" class="delete-field-button" data-index="<%= index %>">削除</button>
        </div>
      <% end %>
      <!-- 새 필드 추가 시 flag 입력은 별도로 1 (추가/수정)로 지정하도록 처리 -->
    </div>
    <button type="button" id="add_photo_field">+</button>
  </div>
  <div>
    <%= f.label :layout, "レイアウト" %><br>
    <%= f.select :layout, options_for_select(["1R", "1K/1DK", "1LDK/2DK", "2LDK", "3LDK以上"], @card_collection.layout) %>
  </div>
  <div>
    <%= f.label :theme, "テーマ" %><br>
    <%= f.select :theme, options_for_select(["お部屋写真", "収納TIP", "ペット", "プラントテリア", "その他"], @card_collection.theme) %>
  </div>
  <div class="actions">
    <%= f.submit "投稿する", id: "submit_btn" %>
  </div>
<% end %>

<script>
  document.addEventListener("turbolinks:load", function() {
    var container = document.getElementById("file_fields_container");

    // 파일 입력 변경 이벤트 (이벤트 위임)
    container.addEventListener("change", function(e) {
      if (e.target && e.target.matches("input[type='file']")) {
        var field = e.target.closest("div[data-index]");
        var flagInput = field.querySelector(".flag-input");
        // 파일이 선택되었으면 flag를 "3" (수정)로 설정, 그렇지 않으면 그대로
        if (e.target.files && e.target.files.length > 0) {
          flagInput.value = "3";
        } else {
          // 기존 필드의 경우는 수정하지 않은 것으로 유지하려면 flag를 그대로 두거나 "0"으로 재설정
          // new 필드의 기본은 "1"
          // 예: if(flagInput.value != "1") { flagInput.value = "0"; }
          flagInput.value = flagInput.value === "1" ? "1" : "0";
        }
      }
    });

    // 텍스트 입력 이벤트 (수정 감지)
    container.addEventListener("input", function(e) {
      if (e.target && e.target.matches("textarea")) {
        var field = e.target.closest("div[data-index]");
        var flagInput = field.querySelector(".flag-input");
        // 텍스트 변경 시 수정 flag를 적용 (단, 신규 필드면 그대로 "1")
        if (flagInput.value !== "1") {
          flagInput.value = "3";
        }
      }
    });

    // 삭제 버튼 이벤트: 삭제 시 flag를 "2"
    container.addEventListener("click", function(e) {
      if (e.target && e.target.matches(".delete-field-button")) {
        e.preventDefault();
        var field = e.target.closest("div[data-index]");
        var flagInput = field.querySelector(".flag-input");
        if (flagInput) { flagInput.value = "2"; }
        field.style.display = "none";
      }
    });

    // 신규 필드 추가 ("+" 버튼)
    var addButton = document.getElementById("add_photo_field");
    addButton.addEventListener("click", function(e) {
      e.preventDefault();
      var index = container.querySelectorAll('div[data-index]').length;
      var div = document.createElement("div");
      div.setAttribute("data-index", index);
      div.innerHTML =
        '<input type="hidden" name="card_collection[flags][]" value="1" class="flag-input">' +
        '<input type="file" name="card_collection[photos][]" id="card_collection_photos_' + index + '" accept="image/*">' +
        '<div id="preview_' + index + '"></div>' +
        '<textarea name="card_collection[contents][]" placeholder="사진의 내용" id="content_' + index + '"></textarea>' +
        '<button type="button" class="delete-field-button" data-index="' + index + '">삭제</button>';
      container.appendChild(div);
    });
  });
</script>

